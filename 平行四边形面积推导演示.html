<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¹³è¡Œå››è¾¹å½¢é¢ç§¯æ¨å¯¼ (å®Œç¾æ¼”ç¤ºç‰ˆ)</title>
    <style>
        :root {
            --primary-color: #4a90e2;
            --accent-color: #d32f2f;
            --bg-color: #f0f4f8;
            --panel-bg: #ffffff;
        }

        body {
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 10px;
            display: flex;
            justify-content: center;
            height: 100vh;
            box-sizing: border-box;
            overflow: hidden; 
        }

        .main-wrapper {
            display: flex;
            gap: 15px;
            width: 100%;
            max-width: 1600px; /* å¢åŠ æœ€å¤§å®½åº¦ */
            height: 98%;
            background: var(--panel-bg);
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            padding: 15px;
            overflow: hidden;
        }

        /* --- å¸ƒå±€è°ƒæ•´ï¼šå·¦ä¾§åŠ å®½ï¼Œå³ä¾§å›ºå®š --- */
        .left-stage {
            flex: 1; /* è‡ªåŠ¨å æ®å‰©ä½™ç©ºé—´ */
            display: flex;
            flex-direction: column;
            align-items: center;
            border-right: 2px dashed #eee;
            padding-right: 15px;
            overflow-y: auto; /* å…è®¸å‚ç›´æ»šåŠ¨ */
            min-width: 0; /* é˜²æ­¢Flexå­é¡¹æº¢å‡º */
        }

        .right-panel {
            flex: 0 0 320px; /* å›ºå®šå®½åº¦ 320px */
            display: flex;
            flex-direction: column;
            background-color: #fbfbfb;
            border-radius: 12px;
            padding: 20px;
            height: 100%;
            box-sizing: border-box;
        }

        h1 { margin: 5px 0 5px 0; color: #333; font-size: 1.6rem; }
        .subtitle { color: #666; margin-bottom: 15px; font-size: 0.95rem; }

        /* --- ç”»å¸ƒè°ƒæ•´ --- */
        canvas {
            background-image: 
                linear-gradient(rgba(0,0,0,0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0,0,0,0.05) 1px, transparent 1px);
            background-size: 25px 25px;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 15px;
            cursor: crosshair;
            /* å…³é”®ï¼šCSSå®½åº¦è®¾ä¸º100%ä»¥é€‚åº”å®¹å™¨ï¼Œä½†HTMLå±æ€§å®½åº¦å¾ˆå¤§ä»¥ä¿æŒæ¸…æ™°åº¦å’Œå®¹çº³å¹³ç§» */
            width: 100%; 
            height: auto;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.02);
        }

        .controls {
            width: 95%;
            background: #f4f7f9;
            padding: 15px 25px;
            border-radius: 10px;
        }

        .control-row {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
            font-size: 1rem;
        }

        .control-row label { flex: 0 0 160px; font-weight: bold; }
        .control-row input { flex: 1; margin: 0 15px; cursor: pointer; }
        .val-label { font-family: monospace; font-weight: bold; color: #555; width: 50px; text-align: right; }

        /* å³ä¾§ç»“è®ºåŒºæ ·å¼ */
        .conclusion-header {
            font-size: 1.3rem;
            font-weight: bold;
            color: var(--primary-color);
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 10px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .step-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 12px;
            overflow-y: auto;
            padding-right: 5px;
        }

        .step-item {
            opacity: 0;
            transform: translateX(20px);
            transition: all 0.5s ease;
            background: white;
            padding: 12px;
            border-radius: 8px;
            border-left: 5px solid transparent;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            font-size: 1.1rem;
            line-height: 1.4;
            display: none;
        }

        .step-item.show { opacity: 1; transform: translateX(0); display: block; border-left-color: var(--primary-color); }
        .step-item.final { border-left-color: var(--accent-color); background-color: #fff5f5; font-size: 1.25rem; font-weight: bold; color: #d32f2f; }
        .highlight { color: var(--accent-color); font-weight: 800; padding: 0 2px; }

        /* æŒ‰é’® */
        .action-btn {
            padding: 10px 20px; font-size: 1rem; border: none; border-radius: 6px;
            cursor: pointer; transition: 0.2s; font-weight: bold; color: white;
        }
        .btn-play { background-color: var(--primary-color); }
        .btn-play:hover { background-color: #357abd; }
        
        .btn-next { 
            background-color: #27ae60; width: 100%; padding: 12px; font-size: 1.1rem;
            margin-top: 15px; box-shadow: 0 4px 0 #219150;
        }
        .btn-next:active { transform: translateY(4px); box-shadow: none; }
        .btn-next:disabled { background-color: #ccc; box-shadow: none; cursor: not-allowed; }
        .btn-reset { background-color: #95a5a6; padding: 4px 8px; font-size: 0.8rem; }

    </style>
</head>
<body>

    <div class="main-wrapper">
        <div class="left-stage">
            <h1>å¹³è¡Œå››è¾¹å½¢é¢ç§¯æ¨å¯¼</h1>
            <p class="subtitle">ä»»æ„ä½ç½®åˆ‡å‰² -> åŠ¨æ€å¹³ç§»æ‹¼åˆ -> è§‚å¯Ÿé•¿å®½å…³ç³»</p>
            
            <canvas id="geoCanvas" width="1200" height="500"></canvas>

            <div class="controls">
                <div class="control-row">
                    <label>1. åˆ‡å‰²ä½ç½® (æ²¿ä¸Šåº•)</label>
                    <input type="range" id="cutSlider" min="0" max="100" value="30">
                    <span class="val-label" id="cutVal">30%</span>
                </div>
                
                <div class="control-row">
                    <label>2. å¹³ç§»æ¼”ç¤º</label>
                    <input type="range" id="animSlider" min="0" max="100" value="0">
                    <span class="val-label" id="animVal">0%</span>
                </div>

                <div style="text-align: center; margin-top: 10px;">
                    <button class="action-btn btn-play" onclick="animateDemo()">â–¶ æ’­æ”¾å¹³ç§»è¿‡ç¨‹</button>
                    <button class="action-btn" style="background:#7f8c8d; margin-left:10px;" onclick="resetDemo()">â†º é‡ç½®æ¼”ç¤º</button>
                </div>
            </div>
        </div>

        <div class="right-panel">
            <div class="conclusion-header">
                ç»“è®ºæ¨å¯¼
                <button class="action-btn btn-reset" onclick="resetSteps()">é‡ç½®</button>
            </div>
            
            <div class="step-container" id="stepContainer">
                <div class="step-item" id="step1">
                    å°†å¹³è¡Œå››è¾¹å½¢æ²¿é«˜å‰ªå¼€ï¼Œå¹³ç§»å·¦ä¾§éƒ¨åˆ†ã€‚
                </div>
                <div class="step-item" id="step2">
                    æ‹¼æˆäº†ä¸€ä¸ªæ ‡å‡†çš„ <span class="highlight">é•¿æ–¹å½¢</span>ã€‚
                </div>
                <div class="step-item" id="step3">
                    é•¿æ–¹å½¢çš„ <span class="highlight">é•¿</span> = å¹³è¡Œå››è¾¹å½¢çš„ <span class="highlight">åº•</span>
                </div>
                <div class="step-item" id="step4">
                    é•¿æ–¹å½¢çš„ <span class="highlight">å®½</span> = å¹³è¡Œå››è¾¹å½¢çš„ <span class="highlight">é«˜ (h)</span>
                </div>
                <div class="step-item final" id="step5">
                    æ‰€ä»¥ï¼š<br>å¹³è¡Œå››è¾¹å½¢é¢ç§¯ = <span class="highlight">åº• Ã— é«˜</span>
                </div>
            </div>

            <button class="action-btn btn-next" id="nextBtn" onclick="nextStep()">ğŸ‘‰ æ˜¾ç¤ºç»“è®º (1/5)</button>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('geoCanvas');
        const ctx = canvas.getContext('2d');
        
        // å‡ ä½•å‚æ•°é…ç½®
        const layout = {
            startX: 50,       // èµ·å§‹X (å·¦è¾¹ç•™ç™½ä¸ç”¨å¤ªå¤šï¼Œå› ä¸ºæˆ‘ä»¬æ˜¯å¾€å³ç§»)
            startY: 120,      // ä¸Šåº• Y
            base: 450,        // å¹³è¡Œå››è¾¹å½¢åº•è¾¹é•¿
            height: 260,      // é«˜
            shift: 160        // å€¾æ–œåç§»é‡
        };

        // é¢œè‰²é…ç½®
        const colors = {
            blue: 'rgba(74, 144, 226, 0.7)', // å›ºå®šéƒ¨åˆ†
            red: 'rgba(231, 76, 60, 0.8)',   // ç§»åŠ¨éƒ¨åˆ†
            stroke: '#2c3e50',
            dim: '#000'
        };

        // çŠ¶æ€å˜é‡
        let currentStep = 0;
        const totalSteps = 5;

        // -----------------------------------------------------------
        // ç»˜å›¾ä¸»é€»è¾‘
        // -----------------------------------------------------------
        function draw() {
            const cutRatio = parseInt(document.getElementById('cutSlider').value) / 100;
            const animProgress = parseInt(document.getElementById('animSlider').value) / 100;

            document.getElementById('cutVal').innerText = Math.round(cutRatio * 100) + '%';
            document.getElementById('animVal').innerText = Math.round(animProgress * 100) + '%';

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // 1. é¡¶ç‚¹å®šä¹‰
            const TL = { x: layout.startX + layout.shift, y: layout.startY }; // ä¸Šåº•å·¦
            const BL = { x: layout.startX, y: layout.startY + layout.height }; // ä¸‹åº•ä¸‹
            const TR = { x: layout.startX + layout.shift + layout.base, y: layout.startY }; // ä¸Šåº•å³
            // ä¸‹åº•å³ç•Œé™ (BR_Bound) ç”¨äºé™åˆ¶åˆ‡å‰²ç‚¹ï¼Œä¿è¯åˆ‡çº¿å‚ç›´è½åœ¨åº•è¾¹ä¸Š
            const BR_Bound = { x: layout.startX + layout.base, y: layout.startY + layout.height }; 
            
            // 2. è®¡ç®—å—é™åˆ‡å‰²ç‚¹ (Cut X)
            // æœ‰æ•ˆåˆ‡å‰²åŒºé—´ï¼šä» [TL.x] åˆ° [BR_Bound.x]
            const validMinX = TL.x;
            const validMaxX = BR_Bound.x;
            const effectiveWidth = validMaxX - validMinX;
            const cutX = validMinX + (effectiveWidth * cutRatio);

            // 3. åŠ¨ç”»å‚æ•°
            const moveDist = layout.base * animProgress; // å‘å³å¹³ç§»è·ç¦» = åº•è¾¹é•¿ * è¿›åº¦

            // --- ç»˜åˆ¶èƒŒæ™¯è™šçº¿ (åŸå½¢è½®å»“) ---
            if (animProgress > 0) {
                drawPoly([TL, TR, BR_Bound, BL], 'transparent', '#ccc', [6, 6]);
            }

            // --- å½¢çŠ¶æ„å»º ---
            // å³ä¾§å›ºå®šéƒ¨åˆ† (è“è‰²)
            // å½¢çŠ¶ï¼šç”±åˆ‡å‰²çº¿å³ä¾§çš„éƒ¨åˆ†ç»„æˆã€‚
            // é¡¶ç‚¹ï¼šåˆ‡å‰²çº¿ä¸Šç«¯, TR, BR_Bound, åˆ‡å‰²çº¿ä¸‹ç«¯
            const rightPoly = [
                { x: cutX, y: layout.startY },
                TR,
                BR_Bound,
                { x: cutX, y: layout.startY + layout.height }
            ];

            // å·¦ä¾§ç§»åŠ¨éƒ¨åˆ† (çº¢è‰²)
            // å½¢çŠ¶ï¼šç”±åˆ‡å‰²çº¿å·¦ä¾§çš„éƒ¨åˆ†ç»„æˆã€‚
            // é¡¶ç‚¹ï¼šTL, åˆ‡å‰²çº¿ä¸Šç«¯, åˆ‡å‰²çº¿ä¸‹ç«¯, BL
            const leftPoly = [
                TL,
                { x: cutX, y: layout.startY },
                { x: cutX, y: layout.startY + layout.height },
                BL
            ];

            // ç»˜åˆ¶å›ºå®šéƒ¨åˆ†
            drawPoly(rightPoly, colors.blue, colors.stroke);

            // ç»˜åˆ¶ç§»åŠ¨éƒ¨åˆ† (åº”ç”¨ translate)
            ctx.save();
            ctx.translate(moveDist, 0);
            drawPoly(leftPoly, colors.red, colors.stroke);

            // ç»˜åˆ¶ç§»åŠ¨éƒ¨åˆ†ä¸Šçš„é«˜ (è™šçº¿+h)
            if (animProgress < 0.99) {
                drawVerticalLine(cutX, layout.startY, layout.startY + layout.height, '#fff', 2, [4,4]);
                ctx.fillStyle = '#fff';
                ctx.font = 'bold 18px Arial';
                ctx.fillText('h', cutX - 15, layout.startY + layout.height/2);
            }
            ctx.restore();

            // --- åŠ¨æ€æ ‡æ³¨ (æ ¸å¿ƒä¿®å¤) ---
            drawDynamicLabels(animProgress, BL, BR_Bound, cutX, layout.height, layout.base);
        }

        // -----------------------------------------------------------
        // æ ‡æ³¨é€»è¾‘ (ä¿®å¤äº†å¯¹é½é—®é¢˜)
        // -----------------------------------------------------------
        function drawDynamicLabels(progress, BL, BR, cutX, h, base) {
            ctx.fillStyle = colors.dim;
            ctx.strokeStyle = colors.dim;
            ctx.font = '18px Arial';
            ctx.textAlign = 'center';
            
            const bottomY = BL.y + 35; // åº•éƒ¨æ–‡å­—Yåæ ‡

            if (progress < 0.95) {
                // --- çŠ¶æ€1ï¼šå¹³è¡Œå››è¾¹å½¢ ---
                // æ ‡æ³¨åº•
                drawBracket(BL.x, bottomY, BR.x, bottomY, "åº• (Base)");
                // æ ‡æ³¨é«˜ (åœ¨å·¦ä¾§å¤–é¢ç”»ä¸€ä¸ªç‹¬ç«‹çš„é«˜ï¼Œæ¸…æ™°)
                // drawBracket(BL.x - 30, BL.y, BL.x - 30, BL.y - h, "h", true);
            } else {
                // --- çŠ¶æ€2ï¼šé•¿æ–¹å½¢ ---
                // æ­¤æ—¶çº¢è‰²éƒ¨åˆ†å·²ç»æ‹¼åˆ°äº†å³è¾¹ã€‚
                // æ•´ä¸ªé•¿æ–¹å½¢çš„å·¦è¾¹ç•Œ = å›ºå®šéƒ¨åˆ†çš„å·¦è¾¹ç•Œ = cutX
                // æ•´ä¸ªé•¿æ–¹å½¢çš„å³è¾¹ç•Œ = cutX + base
                const rectLeft = cutX;
                const rectRight = cutX + base;

                // 1. é•¿ (= å¹³è¡Œå››è¾¹å½¢çš„åº•)
                // æ‹¬å·å®Œå…¨å¯¹é½é•¿æ–¹å½¢çš„å·¦å³è¾¹ç•Œ
                drawBracket(rectLeft, bottomY, rectRight, bottomY, "é•¿ (= å¹³è¡Œå››è¾¹å½¢çš„åº•)");

                // 2. å®½ (= h)
                // æ‹¬å·å¯¹é½é•¿æ–¹å½¢çš„å·¦è¾¹ç•Œ (rectLeft)
                // ä½ç½®ç¨å¾®å‘å·¦åç§»ä¸€ç‚¹ç‚¹ï¼Œé¿å…é‡å 
                drawBracket(rectLeft - 15, BL.y, rectLeft - 15, BL.y - h, "å®½ (= h)", true);
            }
        }

        // -----------------------------------------------------------
        // ç»˜å›¾å·¥å…·å‡½æ•°
        // -----------------------------------------------------------
        function drawPoly(points, fill, stroke, dash=[]) {
            ctx.beginPath();
            ctx.moveTo(points[0].x, points[0].y);
            for(let i=1; i<points.length; i++) ctx.lineTo(points[i].x, points[i].y);
            ctx.closePath();
            ctx.fillStyle = fill;
            ctx.fill();
            ctx.strokeStyle = stroke;
            ctx.setLineDash(dash);
            ctx.lineWidth = 2;
            ctx.stroke();
            ctx.setLineDash([]);
        }

        function drawVerticalLine(x, y1, y2, color, width, dash) {
            ctx.beginPath();
            ctx.moveTo(x, y1);
            ctx.lineTo(x, y2);
            ctx.strokeStyle = color;
            ctx.lineWidth = width;
            ctx.setLineDash(dash);
            ctx.stroke();
            ctx.setLineDash([]);
        }

        function drawBracket(x1, y1, x2, y2, text, isVertical=false) {
            ctx.beginPath();
            const tick = 8;
            if(!isVertical) {
                // æ°´å¹³æ‹¬å·
                ctx.moveTo(x1, y1 - tick); 
                ctx.lineTo(x1, y1);
                ctx.lineTo(x2, y2); 
                ctx.lineTo(x2, y2 - tick);
                ctx.fillText(text, (x1+x2)/2, y1 + 22);
            } else {
                // å‚ç›´æ‹¬å·
                ctx.moveTo(x1 + tick, y1); 
                ctx.lineTo(x1, y1);
                ctx.lineTo(x2, y2); 
                ctx.lineTo(x2 + tick, y2);
                
                ctx.save();
                ctx.translate(x1 - 15, (y1+y2)/2);
                ctx.rotate(-Math.PI/2); // æ—‹è½¬æ–‡å­—
                ctx.fillText(text, 0, 0);
                ctx.restore();
            }
            ctx.stroke();
        }

        // -----------------------------------------------------------
        // äº¤äº’é€»è¾‘
        // -----------------------------------------------------------
        let animId;
        function animateDemo() {
            if(animId) return;
            const slider = document.getElementById('animSlider');
            let val = parseInt(slider.value);
            if(val >= 100) val = 0;
            
            function loop() {
                val += 1.5;
                if(val >= 100) {
                    val = 100;
                    slider.value = val;
                    draw();
                    animId = null;
                    return; 
                }
                slider.value = val;
                draw();
                animId = requestAnimationFrame(loop);
            }
            loop();
        }

        function resetDemo() {
            cancelAnimationFrame(animId);
            animId = null;
            document.getElementById('animSlider').value = 0;
            draw();
        }

        function nextStep() {
            if (currentStep >= totalSteps) return;
            currentStep++;
            const el = document.getElementById('step' + currentStep);
            el.classList.add('show');
            
            // æ»šåŠ¨å¤„ç†
            const container = document.getElementById('stepContainer');
            setTimeout(() => { container.scrollTop = container.scrollHeight; }, 100);

            updateBtnState();
        }

        function resetSteps() {
            currentStep = 0;
            for(let i=1; i<=totalSteps; i++) {
                document.getElementById('step'+i).classList.remove('show');
            }
            updateBtnState();
        }

        function updateBtnState() {
            const btn = document.getElementById('nextBtn');
            if (currentStep >= totalSteps) {
                btn.innerText = "æ¨å¯¼å®Œæˆ âœ…";
                btn.disabled = true;
                btn.style.backgroundColor = "#ccc";
            } else {
                btn.disabled = false;
                btn.style.backgroundColor = "#27ae60";
                if(currentStep === 0) btn.innerText = "ğŸ‘‰ æ˜¾ç¤ºç»“è®º (1/5)";
                else btn.innerText = `ğŸ‘‰ ä¸‹ä¸€æ­¥ (${currentStep + 1}/5)`;
            }
        }

        // äº‹ä»¶ç›‘å¬
        document.getElementById('cutSlider').addEventListener('input', () => {
             // æ”¹å˜åˆ‡å‰²ä½ç½®æ—¶ï¼Œå¼ºåˆ¶é‡ç½®å¹³ç§»çŠ¶æ€ï¼Œé¿å…è§†è§‰é”™ä¹±
             resetDemo();
        });
        document.getElementById('animSlider').addEventListener('input', draw);

        // åˆå§‹åŒ–
        window.onload = draw;

    </script>
</body>
</html>